name: UniversalHtmlViewer - Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_github_release:
        description: 'Create a GitHub Release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      release_tag:
        description: 'Optional tag for manual release (example: v1.0.12)'
        required: false
        type: string

env:
  NODE_VERSION: '22.x'
  CI: 'true'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    env:
      INPUT_CREATE_RELEASE: ${{ github.event.inputs.create_github_release }}
      INPUT_RELEASE_TAG: ${{ github.event.inputs.release_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: spfx/UniversalHtmlViewer/package-lock.json

      - name: Install dependencies
        working-directory: spfx/UniversalHtmlViewer
        run: npm ci --ignore-scripts --loglevel=error --no-fund --no-audit

      - name: Lint
        working-directory: spfx/UniversalHtmlViewer
        run: npm run lint

      - name: Test
        working-directory: spfx/UniversalHtmlViewer
        run: npm test

      - name: Bundle (ship)
        working-directory: spfx/UniversalHtmlViewer
        run: npm run bundle:ship

      - name: Package solution (ship)
        working-directory: spfx/UniversalHtmlViewer
        run: npm run package-solution:ship

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(node -p "require('./spfx/UniversalHtmlViewer/src/webparts/universalHtmlViewer/UniversalHtmlViewerWebPart.manifest.json').version")"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          RELEASE_TAG=""
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            RELEASE_TAG="${GITHUB_REF_NAME}"
          elif [[ -n "${INPUT_RELEASE_TAG:-}" ]]; then
            RELEASE_TAG="${INPUT_RELEASE_TAG}"
          fi
          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"

          SHOULD_RELEASE="false"
          if [[ "${GITHUB_REF_TYPE}" == "tag" || "${INPUT_CREATE_RELEASE:-false}" == "true" ]]; then
            SHOULD_RELEASE="true"
          fi
          echo "should_release=$SHOULD_RELEASE" >> "$GITHUB_OUTPUT"

      - name: Validate release tag matches manifest version
        if: steps.meta.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.meta.outputs.version }}"
          RELEASE_TAG="${{ steps.meta.outputs.release_tag }}"
          EXPECTED_TAG="v${VERSION}"

          if [[ -z "$RELEASE_TAG" ]]; then
            echo "Release tag is required when creating a GitHub release."
            exit 1
          fi

          if [[ "$RELEASE_TAG" != "$EXPECTED_TAG" ]]; then
            echo "Release tag '$RELEASE_TAG' does not match manifest version '$VERSION' (expected '$EXPECTED_TAG')."
            exit 1
          fi

      - name: Prepare release files
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.meta.outputs.version }}"
          PACKAGE_SOURCE="spfx/UniversalHtmlViewer/sharepoint/solution/universal-html-viewer.sppkg"
          PACKAGE_TARGET="release/universal-html-viewer-${VERSION}.sppkg"

          mkdir -p release
          cp "$PACKAGE_SOURCE" "$PACKAGE_TARGET"
          cp README.md release/README.md
          cp docs/Deploy-SharePointOnline.md release/Deploy-SharePointOnline.md
          cp scripts/Deploy-UHV.ps1 release/Deploy-UHV.ps1
          cp scripts/Update-UHVSiteApp.ps1 release/Update-UHVSiteApp.ps1
          cp scripts/Setup-UHVSite.ps1 release/Setup-UHVSite.ps1
          cp scripts/Rollback-UHV.ps1 release/Rollback-UHV.ps1

          (
            cd release
            sha256sum * > SHA256SUMS.txt
          )

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: uhv-release-${{ steps.meta.outputs.version }}
          path: |
            release/universal-html-viewer-${{ steps.meta.outputs.version }}.sppkg
            release/SHA256SUMS.txt
            release/README.md
            release/Deploy-SharePointOnline.md
            release/Deploy-UHV.ps1
            release/Update-UHVSiteApp.ps1
            release/Setup-UHVSite.ps1
            release/Rollback-UHV.ps1

      - name: Create GitHub release
        if: steps.meta.outputs.should_release == 'true' && steps.meta.outputs.release_tag != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.release_tag }}
          target_commitish: ${{ github.sha }}
          name: UniversalHtmlViewer ${{ steps.meta.outputs.version }}
          generate_release_notes: true
          files: |
            release/universal-html-viewer-${{ steps.meta.outputs.version }}.sppkg
            release/SHA256SUMS.txt
